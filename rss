<?xml version="1.0" encoding="UTF-8"?>
<rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
        <title><![CDATA[Bites from Good Eggs]]></title>
        <description><![CDATA[Bites from Good Eggs]]></description>
        <link>http://goodeggs.github.io/bites</link>
        <generator>NodeJS RSS Module</generator>
        <lastBuildDate>Mon, 13 Jan 2014 01:07:10 GMT</lastBuildDate>
        <atom:link href="http://goodeggs.github.io/bites/rss" rel="self" type="application/rss+xml"/>
        <author><![CDATA[Good Eggs]]></author>
        <pubDate>Mon, 13 Jan 2014 01:07:08 GMT</pubDate>
        <item>
            <title><![CDATA[Export This: Interface Design Patterns for Node.js Modules]]></title>
            <description><![CDATA[<p>When you require a module in Node, what are you getting back? When you write a module, what options do you have for designing its interface?</p>
<p>When I was first learning to work in Node I found the sheer number of ways to do things to be a bit overwhelming. JavaScript is extremely flexible and the community of developers contributing to open source seem to have different styles for implementing the same thing.</p>
<p>On my journey with Node I&#39;ve been keeping an eye out the Good Way to do things and adopting them for use in my own work and in our work at Good Eggs.</p>
<p>In this post I&#39;ll share my observations of the Node module system and the ways in which you can use it to encapsulate and share code. My goal is to identify and illustrate useful patterns for module interface design and to help you understand when and how to use them in your own work.</p>
<p>I discuss seven patterns below, many of which can be used in combination. They are:</p>
<ul>
<li><a href="/posts/export-this#namespace">Exports a Namespace</a></li>
<li><a href="/posts/export-this#function">Exports a Function</a></li>
<li><a href="/posts/export-this#higher_order_function">Exports a Higher Order Function</a></li>
<li><a href="/posts/export-this#constructor">Exports a Constructor</a></li>
<li><a href="/posts/export-this#singleton">Exports a Singleton</a></li>
<li><a href="/posts/export-this#global_object">Extends a Global Object</a></li>
<li><a href="/posts/export-this#monkey_patch">Applies a Monkey Patch</a></li>
</ul>
<!-- more -->

<h2>require, exports and module.exports</h2>
<p>First some fundamentals.</p>
<p>In Node requiring a file is requiring the module it defines. All modules have a reference to an implicit <code>module</code> object whose property <code>module.exports</code> is what is returned when you call <code>require</code>. A reference to <code>module.exports</code> is also available as <code>exports</code>.</p>
<p>It&#39;s as if there were an implicit line at the beginning of each module that reads:</p>
<pre class="highlighted"><code class="delphi"><span class="keyword">var</span> <span class="keyword">exports</span> = module.<span class="keyword">exports</span> = <span class="comment">{}</span>;</code></pre>
<p>If you want to export a function, you have to assign it to <code>module.exports</code>. Assigning a function to <code>exports</code> would just reassign the <code>exports</code> reference but <code>module.exports</code> would still point at the original empty object.</p>
<p>So we can define a module <code>function.js</code> that exports a function:</p>
<pre class="highlighted"><code class="matlab"><span class="transposed_variable">module.</span>exports = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">return</span> <span class="cell">{name: <span class="string">'Jane'</span>}</span>;
};</code></pre>
<p>and require it with:</p>
<pre class="highlighted"><code class="php"><span class="keyword">var</span> func = <span class="keyword">require</span>(<span class="string">'./function'</span>);</code></pre>
<p>An important behavior of <code>require</code> is that it caches the value of <code>module.exports</code> and returns that same value for all future calls to <code>require</code>. It caches based on the absolute file path of the required file. So if you want your module to be able to return different values, you should have it export a function that can then be invoked to return a new value.</p>
<p>To demonstrate with the Node REPL:</p>
<pre class="highlighted"><code class="ruby"><span class="variable">$ </span>node
&gt; f1 = <span class="keyword">require</span>(<span class="string">'/Users/alon/Projects/export_this/function'</span>);
[<span class="constant">Function</span>]
&gt; f2 = <span class="keyword">require</span>(<span class="string">'./function'</span>); <span class="regexp">//</span> <span class="constant">Same</span> location
[<span class="constant">Function</span>]
&gt; f1 === f2
<span class="keyword">true</span>
&gt; f1() === f2()
<span class="keyword">false</span></code></pre>
<p>You can see that <code>require</code> is returning the same function instance but that the objects returned by that function are different instances for each call.</p>
<p>For more detail on Node&#39;s module system <a href="http://nodejs.org/api/modules.html">the core docs</a> provide good detail and are worth a read.</p>
<p>And now on to the interface patterns.</p>
<p><a name='namespace'></a></p>
<h2>Exports a Namespace</h2>
<p>A simple and common pattern is to export an object with a number of properties, primarily but not limited to functions. This allows the code requiring the module to pull in a collection of related functionality under a single namespace.</p>
<p>When you require a module that exports a namespace, you&#39;ll usually either assign the entire namespace to a variable and use its members through that reference, or assign members directly to local variables:</p>
<pre class="highlighted"><code class="haskell"><span class="title">var</span> fs = require('fs'),
    readFile = fs.readFile,
    <span class="type">ReadStream</span> = fs.<span class="type">ReadStream</span>;

<span class="title">readFile</span>('./file.txt', function(err, <span class="typedef"><span class="keyword">data</span>) <span class="container">{
  <span class="title">console</span>.<span class="title">log</span>("<span class="title">readFile</span> <span class="title">contents</span>: '%<span class="title">s'</span>", <span class="title">data</span>);
}</span>);</span>

<span class="title">new</span> <span class="type">ReadStream</span>('./file.txt').on('<span class="typedef"><span class="keyword">data</span>', function<span class="container">(<span class="title">data</span>)</span> <span class="container">{
  <span class="title">console</span>.<span class="title">log</span>("<span class="type">ReadStream</span> <span class="title">contents</span>: '%<span class="title">s'</span>", <span class="title">data</span>);
}</span>);</span></code></pre>
<p>Here&#39;s what the <a href="https://github.com/joyent/node/blob/e5346932bcbc523489c9418b82fde31cb666ee99/lib/fs.js#L33"><code>fs</code> core module</a> is doing:</p>
<pre class="highlighted"><code class="nginx"><span class="title">var</span> fs = exports;</code></pre>
<p>It first assigns the local variable <code>fs</code> to the implicit exports object and then assigns function references to properties of <code>fs</code>. Because <code>fs</code> references <code>exports</code> and exports is the object you get when you call <code>require(&#39;fs&#39;)</code> anything assigned to <code>fs</code> will be available on the object you get from <code>require</code>.</p>
<pre class="highlighted"><code class="r">fs.readFile = <span class="keyword">function</span>(path, options, callback_) {
  // <span class="keyword">...</span>
};</code></pre>
<p>Anything is fair game. It then exports a constructor:</p>
<pre class="highlighted"><code class="r">fs.ReadStream = ReadStream;

<span class="keyword">function</span> ReadStream(path, options) {
  // <span class="keyword">...</span>
}
ReadStream.prototype.open = <span class="keyword">function</span>() {
  // <span class="keyword">...</span>
}</code></pre>
<p>When exporting a namespace, you can assign properties to <code>exports</code> as the <code>fs</code> module does above, or assign a new object to <code>module.exports</code>.</p>
<pre class="highlighted"><code class="r">module.exports = {
  version: <span class="string">'1.0'</span>,

  doSomething: <span class="keyword">function</span>() {
    //<span class="keyword">...</span>
  }
}</code></pre>
<p>A common use of exporting a namespace is to export the root of another module so that one require statement gives the caller access to a number of other modules. At Good Eggs, we implement each of our domain models in a separate module that exports the model constructor (see <a href="#constructor">Exports a Constructor</a> below) and then have an index file in the directory where the models live that exports all of the models. This allows us to pull in our models under a <code>models</code> namespace.</p>
<pre class="highlighted"><code class="apache">var models = <span class="keyword">require</span>('./models'),
    <span class="keyword">User</span> = models.<span class="keyword">User</span>,
    Product = models.Product;</code></pre>
<p>For CoffeeScript users, <a href="http://coffeescript.org/#destructuring">destructuring assignment</a> make this even cleaner.</p>
<pre class="highlighted"><code class="apache">{<span class="keyword">User</span>, Product} = <span class="keyword">require</span> './models'</code></pre>
<p><code>index.js</code> might look like:</p>
<pre class="highlighted"><code class="apache">exports.<span class="keyword">User</span> = <span class="keyword">require</span>('./<span class="keyword">user</span>');
exports.Person = <span class="keyword">require</span>('./person');</code></pre>
<p>In reality, we use a small library that requires all sibling files and exports their modules with CamelCase names so the <code>index.js</code> file in our models directory actually reads:</p>
<pre class="highlighted"><code class="ruby"><span class="keyword">module</span>.exports = <span class="keyword">require</span>(<span class="string">'../lib/require_siblings'</span>)(__filename);</code></pre>
<p><a name='function'></a></p>
<h2>Exports a Function</h2>
<p>Another pattern is to export a function as the interface to a module. A common use of this pattern is to export a factory function that returns an object when invoked. We see this when using <a href="http://expressjs.com">Express.js</a>:</p>
<pre class="highlighted"><code class="php"><span class="keyword">var</span> express = <span class="keyword">require</span>(<span class="string">'express'</span>);
<span class="keyword">var</span> app = express();

app.get(<span class="string">'/hello'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(req, res)</span> {</span>
  res.send <span class="string">"Hi there! We're using Express v"</span> + express.version;
});</code></pre>
<p>The function exported by Express is used to create a new Express application. In your own use of this pattern, your factory function may take arguments used to configure or initialize the object returned.</p>
<p>To export a function, you must assign your function to module.exports. <a href="https://github.com/visionmedia/express/blob/2e68ddbae9cec2d0b22f48f35ef4da964f51949e/lib/express.js#L18">Express does</a>:</p>
<pre class="highlighted"><code class="r">exports = module.exports = createApplication;

<span class="keyword">...</span>

<span class="keyword">function</span> createApplication () {
  <span class="keyword">...</span>
}</code></pre>
<p>It&#39;s assigning the <code>createApplication</code> function to <code>module.exports</code> and then to the implicit <code>exports</code> variable. Now <code>exports</code> is the function that the module exports.</p>
<p>Express also uses this exported function as a namespace:</p>
<pre class="highlighted"><code class="profile"><span class="filename">exports.version = '3.1.1';</code></pre>
<p>Note that there&#39;s nothing to stop us from using the exported function as a namespace that can expose references to other functions, constructors or objects serving as namespaces themselves.</p>
<p>When exporting a function, it is good practice to name the function so that it will show up in stack traces. Note the stack trace differences in these two examples:</p>
<pre class="highlighted"><code class="javascript"><span class="comment">// bomb1.js</span>
module.exports = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'boom'</span>);
};</code></pre>
<pre class="highlighted"><code class="javascript"><span class="comment">// bomb2.js</span>
module.exports = <span class="function"><span class="keyword">function</span> <span class="title">bomb</span><span class="params">()</span> {</span>
  <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'boom'</span>);
};</code></pre>
<pre class="highlighted"><code class="r">$ node
&gt; bomb = <span class="keyword">require</span>(<span class="string">'./bomb1'</span>);
[Function]
&gt; bomb()
Error: boom
    at module.exports (/Users/alon/Projects/export_this/bomb1.js:<span class="number">2</span>:<span class="number">9</span>)
    at repl:<span class="number">1</span>:<span class="number">2</span>
    <span class="keyword">...</span>
&gt; bomb = <span class="keyword">require</span>(<span class="string">'./bomb2'</span>);
[Function: bomb]
&gt; bomb()
Error: boom
    at bomb (/Users/alon/Projects/export_this/bomb2.js:<span class="number">2</span>:<span class="number">9</span>)
    at repl:<span class="number">1</span>:<span class="number">2</span>
    <span class="keyword">...</span></code></pre>
<p>There are a couple specific cases of exporting a function that are worth calling out as distinct patterns.</p>
<p><a name='higher_order_function'></a></p>
<h2>Exports a Higher Order Function</h2>
<p>A higher-order function, or functor, is a function that  takes one or more functions as an input and/or outputs a function. We&#39;re talking about the latter case - a function that returns a function.</p>
<p>Exporting a higher order function is a useful pattern when you want to return a function from your module but need to take input that controls the behavior of that function.</p>
<p><a href="http://www.senchalabs.org/connect/">Connect middleware</a> provide a lot of pluggable functionality for Express and other web frameworks. A middleware is a function that takes three arguments - <code>(req, res, next)</code>. The convention in connect middleware is to export a function that when called returns the middleware function. This allows the exported function to take arguments that can be used to configure the middleware and are available through closure scope to the middleware when it is handling a request.</p>
<p>For example, here&#39;s the connect <a href="http://www.senchalabs.org/connect/query.html"><code>query</code> middleware</a> used internally by Express to parse query string parameters into a an object available as <code>req.query</code>.</p>
<pre class="highlighted"><code class="php"><span class="keyword">var</span> connect = <span class="keyword">require</span>(<span class="string">'connect'</span>),
    query = <span class="keyword">require</span>(<span class="string">'connect/lib/middleware/query'</span>);

<span class="keyword">var</span> app = connect();
app.<span class="keyword">use</span>(query({maxKeys: <span class="number">100</span>}));</code></pre>
<p>The <code>query</code> source looks like:</p>
<pre class="highlighted"><code class="lua">var qs = <span class="built_in">require</span>(<span class="string">'qs'</span>)
  , parse = <span class="built_in">require</span>(<span class="string">'../utils'</span>).parseUrl;

<span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">query</span><span class="params">(options)</span></span>{
  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">query</span><span class="params">(req, res, next)</span></span>{
    <span class="keyword">if</span> (!req.query) {
      req.query = ~req.url.indexOf(<span class="string">'?'</span>)
        ? qs.parse(parse(req).query, options)
        : {};
    }

    <span class="built_in">next</span>();
  };
};</code></pre>
<p>For every request handled by the <code>query</code> middleware, the <code>options</code> argument available through closure scope is passed along to Node&#39;s core <code>qs</code> (query string) module.</p>
<p>This is a common and very flexible pattern for module design and one you are likely to find very useful in your own work.</p>
<p><a name='constructor'></a></p>
<h2>Exports a Constructor</h2>
<p>We define classes in JavaScript with constructor functions and create instances of classes with the <code>new</code> keyword.</p>
<pre class="highlighted"><code class="delphi"><span class="function"><span class="keyword">function</span> <span class="title">Person</span><span class="params">(name)</span> <span class="comment">{
  this.name = name;
}</span>

<span class="title">Person</span>.<span class="title">prototype</span>.<span class="title">greet</span> = <span class="title">function</span><span class="params">()</span> <span class="comment">{
  return "Hi, I'm Jane.";
}</span>;</span>

<span class="keyword">var</span> person = new Person(<span class="string">'Jane'</span>);
console.log(person.greet()); <span class="comment">// prints: Hi, I'm Jane</span></code></pre>
<p>For this pattern implement a class-per-file and export the constructor to make your project organization clear and to make it easy for other developers to find the implementation of a class. At Good Eggs, we implement classes in files with underscore_names and assign them to CamelCase names.</p>
<pre class="highlighted"><code class="php"><span class="keyword">var</span> Person = <span class="keyword">require</span>(<span class="string">'./person'</span>);

<span class="keyword">var</span> person = <span class="keyword">new</span> Person(<span class="string">'Jane'</span>);</code></pre>
<p>The implementation might look like:</p>
<pre class="highlighted"><code class="delphi"><span class="function"><span class="keyword">function</span> <span class="title">Person</span><span class="params">(name)</span> <span class="comment">{
  this.name = name;
}</span>

<span class="title">Person</span>.<span class="title">prototype</span>.<span class="title">greet</span> = <span class="title">function</span><span class="params">()</span> <span class="comment">{
  return "Hi, I'm " + this.name;
}</span>;</span>

module.<span class="keyword">exports</span> = Person;</code></pre>
<p><a name='singleton'></a></p>
<h2>Exports a Singleton</h2>
<p>Export a <a href="http://en.wikipedia.org/wiki/Singleton_pattern">singleton</a> when you want all users of your module to share the state and behavior of a single class instance.</p>
<p><a href="http://mongoosejs.com">Mongoose</a> is an object-document mapping library used to create rich domain models persisted in MongoDB.</p>
<pre class="highlighted"><code class="r">var mongoose = <span class="keyword">require</span>(<span class="string">'mongoose'</span>);
mongoose.connect(<span class="string">'mongodb://localhost/test'</span>);

var Cat = mongoose.model(<span class="string">'Cat'</span>, { name: String });

var kitty = new Cat({ name: <span class="string">'Zildjian'</span> });
kitty.save(<span class="keyword">function</span> (err) {
  <span class="keyword">if</span> (err) // <span class="keyword">...</span>
  console.log(<span class="string">'meow'</span>);
});</code></pre>
<p>What is that <code>mongoose</code> object we get back when we require Mongoose? Internally, the <code>mongoose</code> module is doing:</p>
<pre class="highlighted"><code class="r"><span class="keyword">function</span> Mongoose() {
  //<span class="keyword">...</span>
}

module.exports = exports = new Mongoose();</code></pre>
<p>Because <code>require</code> caches the value assigned to <code>module.exports</code>, all calls to <code>require(&#39;mongoose&#39;)</code> will return this same instance ensuring that it is a singleton in our application. Mongoose uses an object-oriented design to encapsulate and decouple functionality, maintain state and support readability and comprehension, but creates a simple interface to users by creating and exporting an instance of the Mongoose class.</p>
<p>It also uses this singleton instance as a namespace to make other constructors available if needed by the user, including the Mongoose constructor itself. You might use the <code>Mongoose</code> constructor to create additional instances of mongoose connecting to additional MongoDB databases.</p>
<p>Internally, Mongoose does:</p>
<pre class="highlighted"><code class="avrasm">Mongoose<span class="preprocessor">.prototype</span><span class="preprocessor">.Mongoose</span> = Mongoose<span class="comment">;</span></code></pre>
<p>So that you can do:</p>
<pre class="highlighted"><code class="php"><span class="keyword">var</span> mongoose = <span class="keyword">require</span>(<span class="string">'mongoose'</span>),
    Mongoose = mongoose.Mongoose;

<span class="keyword">var</span> myMongoose = <span class="keyword">new</span> Mongoose();
myMongoose.connect(<span class="string">'mongodb://localhost/test'</span>);</code></pre>
<p><a name='global_object'></a></p>
<h2>Extends a Global Object</h2>
<p>A required module can do more than just export a value. It can also modify global objects or objects returned when requiring other modules. It can define new global objects. It can just do this or do this in addition to exporting something useful.</p>
<p>Use this pattern when you need to extend or alter the behavior of global objects to provide the behavior delivered by your module. While certainly controversial and to be used judiciously (especially in open source work), this pattern can also be indispensable.</p>
<p><a href="https://github.com/visionmedia/should.js">Should.js</a> is an assertion library designed to be used in unit testing:</p>
<pre class="highlighted"><code class="matlab">require(<span class="string">'should'</span>);

var user = <span class="cell">{
    name: <span class="string">'Jane'</span>
}</span>;

<span class="transposed_variable">user.</span><span class="transposed_variable">name.</span><span class="transposed_variable">should.</span>equal(<span class="string">'Jane'</span>);</code></pre>
<p>Should.js <a href="https://github.com/visionmedia/should.js/blob/68000f47d01408cacb80441a1d9bf10ba423e54c/lib/should.js#L107-L113">extends Object with a non-enumerable property <code>should</code></a> to provide a clean syntax for writing unit test asserts. Internally, <code>should.js</code> does:</p>
<pre class="highlighted"><code class="r">var should = <span class="keyword">function</span>(obj) {
  <span class="keyword">return</span> new Assertion(util.isWrapperType(obj) ? obj.valueOf(): obj);
};

//<span class="keyword">...</span>

exports = module.exports = should;

//<span class="keyword">...</span>

Object.defineProperty(Object.prototype, <span class="string">'should'</span>, {
  set: <span class="keyword">function</span>(){},
  get: <span class="keyword">function</span>(){
    <span class="keyword">return</span> should(this);
  },
  configurable: true
});</code></pre>
<p>Note that while Should.js exports the <code>should</code> function its primary use is through the <code>should</code> function it has added to <code>Object</code>.</p>
<p><a name='monkey_patch'></a></p>
<h2>Applies a Monkey Patch</h2>
<p>By <a href="http://en.wikipedia.org/wiki/Monkey_patch">monkey patch</a> I&#39;m referring to &quot;the dynamic modifications of a class or module at runtime, motivated by the intent to patch existing third-party code as a workaround to a bug or feature which does not act as desired.&quot;</p>
<p>Implement a module to patch an existing module when it doesn&#39;t provide an interface to customizing its behavior in the way you need. This pattern is a variant of the previous. Instead of modifying a global object, we are relying on the caching behavior of Node&#39;s module system to patch the same instance of a module that other code gets when it requires that module.</p>
<p>By default Mongoose names MongoDB collections by lowercasing and pluralizing the model name. For a model named <code>CreditCardAccountEntry</code> we&#39;d end up with a collection named <code>creditcardaccountentries</code>. I prefer <code>credit_card_account_entries</code> and I want this behavior universally.</p>
<p>Here&#39;s the source for a module that patches <code>mongoose.model</code> when the module is required:</p>
<pre class="highlighted"><code class="php"><span class="keyword">var</span> Mongoose = <span class="keyword">require</span>(<span class="string">'mongoose'</span>).Mongoose;
<span class="keyword">var</span> _ = <span class="keyword">require</span>(<span class="string">'underscore'</span>);

<span class="keyword">var</span> model = Mongoose.prototype.model;
<span class="keyword">var</span> modelWithUnderScoreCollectionName = function(name, schema, collection, skipInit) {
  collection = collection || _(name).chain().underscore().pluralize().value();
  model.call(<span class="keyword">this</span>, name, schema, collection, skipInit)
};
Mongoose.prototype.model = modelWithUnderScoreCollectionName</code></pre>
<p>When this module is required for the first time, it requires <code>mongoose</code>, redefines <code>Mongoose.prototype.model</code> and delegates back to the original implementation of <code>model</code>. Now all instances of <code>Mongoose</code> will have this new behavior. Note that it does not modify <code>exports</code> so the value returned to <code>require</code> will be the default empty <code>exports</code> object.</p>
<p>As a side note, if you do choose to monkey patch existing code, use a chaining technique similar to my example above. Add your behavior then delegate back to the original implementation. While not foolproof, it is the safest way to patch third party code allowing you to take advantage of future updates to the library and minimizing conflict with other patches that may be applied.</p>
<h2>Export Away!</h2>
<p>The Node module system provides a simple mechanism for encapsulating functionality and creating clear interfaces to your code. I hope the seven patterns here are a useful breakdown of different strategies available to you.</p>
<p>I haven&#39;t been exhaustive and there are certainly other options available but I have attempted to describe the most common and useful. Have I missed anything that should be included here?</p>
<p><em>Thanks to the incredibly prolific Node developer community for all the open source work from which I have done most of my learning. I encourage you to read the code of the libraries you are using and to find the great developers out there with clear, consistent and readable styles that can inspire your own. Special shout out to <a href="https://github.com/visionmedia">TJ Holowaychuk</a> whose work on Express.js, Connect and Should.js are referenced above.</em></p>
]]></description>
            <link>http://goodeggs.github.io/bites/posts/export-this/</link>
            <guid isPermaLink="true">
                http://goodeggs.github.io/bites/posts/export-this/            </guid>
            <dc:creator><![CDATA[Alon Salant]]></dc:creator>
            <pubDate>Sun, 12 Jan 2014 00:00:00 GMT</pubDate>
        </item>
        <item>
            <title><![CDATA[Cultivate Inaugural Meetup]]></title>
            <description><![CDATA[<p>The first <a href="http://www.meetup.com/cultivate">Cultivate meetup</a> was a huge success.</p>
<blockquote>
&quot;great first event for a meetup with a compelling mix of javascript code and social impact&quot;
</blockquote>

<blockquote>
&quot;Great meetup! Lots of interesting people and talks. Looking forward to future ones.&quot;
</blockquote>

<blockquote>
&quot;This was a great way to kickoff the Cultivate meetups; I left informed, enthused, (oh yeah, and nourished) and committed to return.&quot;
</blockquote>

<p>Over 80 members of the developer community came together on a chilly San Francisco night, under a common purpose: to use technology for the betterment of humanity and the planet.</p>
<p>As Good Eggs CTO Alon Salant said in an opening statement, &quot;We are building tools that affect real people in the real world. It&#39;s about affecting real change in someone&#39;s work to enhance their life.&quot;</p>
<p>The event kicked off with with a delicious bang: <a href="http://www.goodeggs.com/loveandhummus">Love &amp; Hummus</a> delivered an exceptional dining experience. Hearty falafel wraps, homemade tahini sauce, spicy hummus, sultry baklava, and mint-garnish lemonade.</p>
<p>If your mouth isn&#39;t watering yet, wait till you sink your teeth into the presentations..</p>
<!-- more -->

<h2>Hanging up on Callbacks - [More than] Flow Control w/ECMAScript 6 Generators</h2>
<p><a href="http://www.carbonfive.com/employee/erin-swenson-healey">Erin Swanson-Healey</a> from Carbon Five gave a thorough walk-through into dealing with asynchronous callbacks in Javascript. With charisma and charm he  stated that we have new ways to deal with &quot;callback hell&quot;.</p>
<p>New Solution: <a href="http://www.2ality.com/2013/06/iterators-generators.html">ECMAScript 6</a> provides generators, which alleviates some of challenges that are associated with asynchronous callbacks.</p>
<p>Read Erin&#39;s <a href="http://blog.carbonfive.com/2013/12/01/hanging-up-on-callbacks-generators-in-ecmascript-6/">detailed blog post</a> on the topic, and check out his <a href="https://docs.google.com/a/goodeggs.com/presentation/d/1c23KjxQIoKKjho2wnjRXdJhmWd6X3g10B5ggC1DUE0M/edit#slide=id.p">slides</a> from the presentation here.</p>
<h2>Whats new in Node v0.12.</h2>
<p>Next up was <a href="https://github.com/piscisaureus">Bert Belder</a> from StrongLoop. Bert is one of the principal authors of <a href="http://nikhilm.github.io/uvbook/introduction.html">libuv</a>, which is the library on which Node.js is built. Needless to say, we were stoked to see him present at the first Cultivate meetup!</p>
<p>Bert provided insight into:</p>
<ul>
<li>Round-robin clustering</li>
<li>Profiling</li>
<li>ExecSync</li>
<li>Multi-context</li>
</ul>
<p>Read more about <a href="http://strongloop.com/strongblog/whats-new-in-node-js-v0-12-cluster-round-robin-load-balancing/">cluster round-robin load balancing</a> from StrongLoop. For kicks, here is <a href="http://www.youtube.com/watch?v=QnO6Uut4Ao8">a video of Bert at LXJS 2013</a> - being a boss!</p>
<h2>MongoDB Performance Fundamentals for Web Apps</h2>
<p><a href="http://www.goodeggs.com/about/team/sfbay/522103184f08c30300000028">Adam Hull</a> from Good Eggs was our final presenter, and he finished strong! We were lucky to have insights from Adam into performance, speed, and use of Mongo. The presentation ended with a pretty long Q&amp;A session that surfaced  answers to some questions that the collective developer community seemed to have been yearning to ask. Many of the remarks were confirmed with a head-nod from two developers from MongoLab in the audience. Head nods and &quot;ah ha&#39;s&quot; all around!</p>
<h2>Lightning Talks</h2>
<p>Flashing through in 5-minute intervals, our speedy speakers were able to capture the audience with cool projects and insights, including:</p>
<ul>
<li>Jessica Lam - <a href="http://www.sgrbx.io/#/play/sHMVrO1jg8">real-time collaboration with sugarbox.io</a></li>
<li>Max Edmands - <a href="http://danieltao.com/lazy.js/">lazy.js</a> + <a href="https://github.com/demands/lazy-presentation">slides</a></li>
<li>Stewart Noyce - <a href="http://www.trunort.com/docs/Cultivate-Dec2013.pdf">lessons learned</a></li>
<li>Shubhra Kar - <a href="http://strongloop.com/strongloop-suite/strongops/">StrongOps Node performance monitoring dashboard</a></li>
<li>Alon Salant, - <a href="https://github.com/goodeggs/fibrous">fibrous library</a></li>
</ul>
<p>Overall, from our speakers there is one common thread: writing great apps with JavaScript is hard work. But with new tools, techniques and frameworks emerging, we can &quot;cultivate&quot; the developer community into a unified force, working together to blend technology and awareness to benefit humankind, the planet, and our future.</p>
<p>Join us for our next event, happening in early 2014!</p>
<p>Check back regularly <a href="http://www.meetup.com/cultivate"><a href="http://www.meetup.com/cultivate">http://www.meetup.com/cultivate</a></a> or email <a href="mailto:kevin@goodeggs.com">kevin@goodeggs.com</a> for suggestions or details.</p>
<p>Cheers!</p>
]]></description>
            <link>http://goodeggs.github.io/bites/posts/first-cultivate-meetup/</link>
            <guid isPermaLink="true">
                http://goodeggs.github.io/bites/posts/first-cultivate-meetup/            </guid>
            <dc:creator><![CDATA[Kevin Uland]]></dc:creator>
            <pubDate>Fri, 06 Dec 2013 00:00:00 GMT</pubDate>
        </item>
        <item>
            <title><![CDATA[In Season for Fall and Winter]]></title>
            <description><![CDATA[<p>Last week <a href="http://blog.goodeggs.com/post/62349630794/were-thrilled-to-partner-with-sequoia-capital-to">we announced our Series A funding</a>
led by Sequoia Capital. After a summer of hustling to grow sales and build tools to keep great local food flowing smoothly
through our San Francisco foodhub we can now turn attention to building the systems we need to scale Good Eggs in
Brooklyn, New Orleans, Los Angeles and beyond.</p>
<p>Here&#39;s an overview of what we&#39;re working on and what&#39;s coming up for the software development team at Good Eggs.</p>
<!-- more -->

<p>We have three domains in which we are building applications:</p>
<ul>
<li>Local food shopping</li>
<li>Producer business tools</li>
<li>Just-in-time logistics</li>
</ul>
<p>We have a dedicated product team working on each of these domains. A product team consists of
a product lead, four to six engineers and a designer. Engineers regularly rotate among teams so we get the great
cross-pollination and learning that comes from collaborating with new people.</p>
<h2>Local food shopping</h2>
<p><a href="http://www.goodeggs.com">GoodEggs.com</a> is a great online food shopping experience that is more convenient than going to the grocery store while
supporting a direct connection to the people producing your food. Today you can shop in any of four foodsheds
(SF Bay, Brooklyn, New Orleans, Los Angeles) and buy food directly from hundreds of farmers or foodmakers for fulfillment
by Good Eggs or directly by the producer. We&#39;ll send you pickup and delivery reminders by email and SMS and a
regular weekly email that keeps you up to date with the new seasonal products regularly showing up in the market.</p>
<p>Our challenge is to create an experience that helps busy people to easily get food they trust and love on their tables.
Coming up for this team is creating a search experience to help you find exactly what you are looking for, richer
stories and media about the many farmers and foodmakers that power Good Eggs, a mobile
app so that you can buy those salad greens right when you think of it instead of adding to your grocery list, and features
to help you discover more great food from your friends and family who are also eating well on Good Eggs.</p>
<h2>Producer business tools</h2>
<p>Our tools for farmers and foodmakers enable them to manage their products and inventory,
create promotions and do their own customer service by issuing refunds and communicating directly with their customers.
They receive email alerts when shoppers buy their products
and daily emails that coordinate their production and delivery schedules with our receiving staff.</p>
<p>Our challenge is to bring big business technology smarts to serve small and mid-size businesses. For businesses that
largely run off paper and spreadsheets, we&#39;ve already made a world of difference. We&#39;re turning our attention now to
improving the mobile experience since these people are more often on a phone than at a computer. We&#39;re looking at ways to
use the data about what people are buying and when to help these businesses make better decisions about what to plant, raise
and prepare in order to run more efficient and profitable businesses.</p>
<h2>Just-in-time logistics</h2>
<p>Our logistics systems power a new kind of food distribution characterized by just-in-time fulfillment through our
physical food hubs in San Francisco, Brooklyn, New Orleans and Los Angeles. We receive food from producers in the morning,
start packing orders at 11am and have the first vehicles going out by 1pm to delivery and pickup locations. All food that
arrives in our foodhub has already been sold and is destined for a customer&#39;s plate.</p>
<p>This system is actually a suite of applications that tie together receiving, packing, routing, driving and customer service
to provide a seamless experience to our customers. It is the real engine behind Good Eggs.
It must be fault-tolerant and handle smoothly the many small issues that arise when tracking real food as it moves through the day
from producer to customer.</p>
<p>We&#39;ve evolved this system rapidly with a combination of digital and paper tools. Each morning we print receiving, packing and route
sheets that our Local Food Dispatcher teams use to assemble and deliver orders. Paper has been a fantastic medium for this
experimentation as it is infinitely hackable. We can make notes, update information or create a stack of issues to be picked
up and handled by someone else. It has enabled us to iterate extremely quickly and invent new practices as we go.</p>
<p>We&#39;re now ready to codify much of these practices into the next version of our logistics software. Our receiving team
is already using our new tablet-based receiving app, code-named Kale and built with AngularJS, to record all food entering the foodhub, track
temperature/cold chain for chill and frozen items, and identify issues to be handled by customer service. On deck is an
app for our drivers to easily follow their delivery routes, communicate with customers on the go and provide a more personalized
experience when they arrive at their door.</p>
<h2>The Future</h2>
<p>We&#39;ve got our work cut out for us. As our teams grow in other foodsheds, one of the best ways we can serve them is
to deliver great software that embodies the effective practices we have developed scaling up our San Francisco foodhub.
These practices continue to evolve so we&#39;re building these systems to be as simple and malleable as possible. One thing
that we can rely on for the future is that we will always be learning, changing and improving.</p>
]]></description>
            <link>http://goodeggs.github.io/bites/posts/fall-2013/</link>
            <guid isPermaLink="true">
                http://goodeggs.github.io/bites/posts/fall-2013/            </guid>
            <dc:creator><![CDATA[Alon Salant]]></dc:creator>
            <pubDate>Mon, 30 Sep 2013 00:00:00 GMT</pubDate>
        </item>
        <item>
            <title><![CDATA[Fibrous on Harmony Generators? Impossible]]></title>
            <description><![CDATA[<p>A good Friday afternoon chat about asynchronous programming models left me wondering if the fibrous API could be implemented on top of <a href="http://wiki.ecmascript.org/doku.php?id=harmony:generators">ES6 generators</a>. Generators are baked in to Node 0.11, Chrome 19, and Firefox.  A port would be a big boost to interoperability.  <a href="https://github.com/google/traceur-compiler">Traceur</a> can even transform generator based code into a <a href="http://traceur-compiler.googlecode.com/git/demo/repl.html#function*%20test%20()%20%7B%0A%20%20yield%201%3B%0A%20%20var%20a%20%3D%20yield%202%3B%0A%20%20try%20%7B%0A%20%20%20%20yield%20a%3B%0A%20%20%7D%20catch%20(e)%20%7B%0A%20%20%20%20yield%2099%3B%0A%20%20%7D%0A%20%20for(var%20i%20%3D0%3B%20i%20%3C%201%3B%20i%2B%2B)%20%7B%0A%20%20%20%20yield%20123%3B%0A%20%20%7D%0A%7D%0A%0Afunction%20normal()%20%7B%0A%20%20var%20a%20%3D%20b%3B%0A%20%20return%20b%3B%0A%7D">giant state machine</a> that runs on all of today&#39;s environments.</p>
<p>At first the port looked promising. Wikipedia claimed that general coroutines could be <a href="http://en.wikipedia.org/wiki/Coroutine#Comparison_with_generators">built on generators</a>, and many folks have <a href="http://taskjs.org/">done</a> <a href="https://gist.github.com/creationix/5762837">just</a> <a href="https://gist.github.com/Benvie/5667557">that</a>.  After a little noodling I&#39;m pretty sure it can&#39;t be done.  In a Harmony environment a function can only suspend execution at <code>yield</code> expressions and <code>yield</code> expressions can only appear in generator functions. A yield expression cannot be wrapped up behind a fibrous <code>sync</code> or <code>wait</code>.</p>
<!-- more -->

<p>Let&#39;s say we&#39;ve got a fibrous function <code>f</code> that synchronously calls asychronous function <code>g</code>:</p>
<pre class="highlighted"><code class="javascript"><span class="keyword">var</span> g = <span class="keyword">function</span>(callback) {
  setTimeout(<span class="keyword">function</span>() {
    console.log(<span class="string">'g done'</span>);
    callback();
  }, <span class="number">1000</span>);
};

<span class="keyword">var</span> f = fibrous(<span class="keyword">function</span>() {
  g.sync();
  console.log(<span class="string">'f done'</span>);
};</code></pre>
<p>When we call <code>f</code> we wait one second, log <code>&#39;g done&#39;</code>, then log <code>&#39;f done&#39;</code>.  We need to halt <code>f</code> before the <code>console.log</code>, but <code>f</code> has no yield expressions.  It cannot be halted with any combination of ES6 generators.  Tough break.</p>
<hr>
<h3>Related</h3>
<ul>
<li><a href="http://taskjs.org/">Task.js</a> seems like a great way to get fibrous-like behavior within the generator constraints.  Still waiting on <a href="https://github.com/mozilla/task.js/issues/28">ES6 syntax support</a> and a <a href="https://github.com/mozilla/task.js/issues/17">CommonJS module published to NPM</a>.</li>
<li>Fellow coffee lovers, the proposed <a href="https://github.com/jashkenas/coffee-script/pull/3078">coffee script syntax for generators</a> is a &#39;lil fugly and worth checking out.</li>
</ul>
]]></description>
            <link>http://goodeggs.github.io/bites/posts/fibrous-on-harmony-generators/</link>
            <guid isPermaLink="true">
                http://goodeggs.github.io/bites/posts/fibrous-on-harmony-generators/            </guid>
            <dc:creator><![CDATA[Adam Hull]]></dc:creator>
            <pubDate>Sat, 17 Aug 2013 00:00:00 GMT</pubDate>
        </item>
        <item>
            <title><![CDATA[Ids in Mongoose, JSON, and Backbone]]></title>
            <description><![CDATA[<p>Mongoose adds <a href="http://mongoosejs.com/docs/guide.html#id">id sugar</a> on top the default _id document attribute.  Backbone has <a href="http://backbonejs.org/#Model-idAttribute">similar sugar</a>, but the types don&#39;t line up.  Pushing bits between the two with a customary JSON document adds a third representation.</p>
<p>If you find yourself typing <code>vegetable.id</code> when you really needed <code>new ObjectID(vegetable.toJSON()._id)</code> this fancy chart might help:
<!-- more --></p>
<table class="ids">
  <tr><th>Mongoose</th><th>id</th><th>_id</th></tr>
  <tr><td><a href="http://mongoosejs.com/docs/api.html#document_Document-id">document</a></td><td>String</td><td>ObjectID</td></tr>
  <tr><td><a href="http://mongoosejs.com/docs/api.html#query_Query-lean">lean document</a></td><td>∅</td><td>ObjectID</td></tr>
  <tr><td><a href="http://mongoosejs.com/docs/api.html#document_Document-toJSON">document.toJSON()</a></td><td>∅</td><td>ObjectID</td></tr>

  <tr><th>JSON</th><th></th><th></th></tr>
  <tr><td><a href="http://www.json.org/">object</a></td><td>∅</td><td>String</td></tr>

  <tr><th>Backbone</th><th></th><th></th></tr>
  <tr><td><a href="http://backbonejs.org/#Model-id">model</td><td>String</td><td>∅</td></tr>
  <tr><td><a href="http://backbonejs.org/#Model-get">model.get()</td><td>∅</td><td>String</td></tr>
</table>]]></description>
            <link>http://goodeggs.github.io/bites/posts/ids-in-mongoose-json-and-backbone/</link>
            <guid isPermaLink="true">
                http://goodeggs.github.io/bites/posts/ids-in-mongoose-json-and-backbone/            </guid>
            <dc:creator><![CDATA[Adam Hull]]></dc:creator>
            <pubDate>Tue, 02 Apr 2013 00:00:00 GMT</pubDate>
        </item>
        <item>
            <title><![CDATA[Structuring Expressions in CoffeeScript]]></title>
            <description><![CDATA[<p>CoffeeScript can save as many keystrokes putting objects together as it can taking them apart.</p>
<p class="update">
  For a while I was calling this lexeme <em>restructuring assignment</em> until some on Stack Overflow <a href="http://stackoverflow.com/a/14822198/407845">pointed out that name was ridiculous</a>.  Now I&#39;ve taken to the name <em>structuring expressions</em>.
</p>

<!-- more -->

<p>Sure <a href="http://blog.carbonfive.com/2011/09/28/destructuring-assignment-in-coffeescript/">C5 told you all about</a> CoffeeScript’s <a href="http://coffeescript.org/#destructuring">destructing assignment</a> syntax for objects…</p>
<p>How it can reach deep into nested structures</p>
<pre class="highlighted"><code class="coffeescript">coffee&gt; user = name: <span class="string">'Foo'</span>, age: <span class="number">42</span>, address: { city: <span class="string">'Anytown'</span>, state:
<span class="string">'AL'</span> }
{ name: <span class="string">'Foo'</span>, age: <span class="number">42</span>, address: { city: <span class="string">'Anytown'</span>, state: <span class="string">'AL'</span> } }

coffee&gt; { address: { city, state } } = user
{ name: <span class="string">'Foo'</span>, age: <span class="number">42</span>, address: { city: <span class="string">'Anytown'</span>, state: <span class="string">'AL'</span> } }

coffee&gt; city
<span class="string">'Anytown'</span></code></pre>
<p>Or pluck apart function arguments</p>
<pre class="highlighted"><code class="coffeescript"><span class="function"><span class="title">displayName</span></span> = ({ name, age }) -&gt;
  console.log <span class="string">"<span class="subst">#{name}</span>, <span class="subst">#{age}</span> year(s) old"</span>

coffee&gt; displayName name: <span class="string">'Foo'</span>, age: <span class="number">42</span>
Foo, <span class="number">42</span> year(s) old</code></pre>
<p>Or even destructure directly to instance attributes</p>
<pre class="highlighted"><code class="coffeescript"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>
  constructor: ({ <span class="property">@name</span>, <span class="property">@age</span> }) -&gt;

coffee&gt; <span class="keyword">new</span> User(name: <span class="string">'Foo'</span>, age: <span class="number">42</span>)
{ name: <span class="string">'foo'</span>, age: <span class="number">42</span> }</code></pre>
<p>But what does this do?</p>
<pre class="highlighted"><code class="coffeescript">coffee&gt; age = <span class="number">42</span>
<span class="number">42</span>

coffee&gt; user = { <span class="string">'Foo'</span>, age }
?</code></pre>
<p>My fudge-fingers managed to mash that one unknowingly into my editor one day while attempting to rack up velocity points on the latest story. Instead of hemorrhaging the expected SyntaxError, it evaluated to this beautiful new object</p>
<pre class="highlighted"><code class="coffeescript">{ Foo: <span class="string">'Foo'</span>, age: <span class="number">42</span> }</code></pre>
<p>Now I’ve got a handy set syntax</p>
<pre class="highlighted"><code class="coffeescript">coffee&gt; <span class="number">2</span> <span class="keyword">of</span> { <span class="number">1</span>, <span class="number">2</span>, <span class="number">5</span> }
<span class="literal">true</span>

coffee&gt; <span class="number">2</span> <span class="keyword">of</span> { <span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span> }
<span class="literal">false</span></code></pre>
<p>And with consistent variable naming, breezy data marshaling between some framework actors</p>
<pre class="highlighted"><code class="coffeescript"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>
  constructor: ({ <span class="property">@name</span>, <span class="property">@age</span> }) -&gt;

<span class="function"><span class="title">template</span></span> = ({ user, face }) -&gt;
  <span class="string">"&lt;div&gt;<span class="subst">#{user.name}</span> <span class="subst">#{face}</span>&lt;/div&gt;"</span>

<span class="class"><span class="keyword">class</span> <span class="title">UserView</span></span>
  constructor: ({ <span class="property">@user</span> }) -&gt;

  render: -&gt;
    <span class="property">@html</span> = template {
      <span class="property">@user</span>
      face: <span class="string">':)'</span>
    }

coffee&gt; user = <span class="keyword">new</span> User(name: <span class="string">'Foo'</span>, age: <span class="number">42</span>)
{ name: <span class="string">'Foo'</span>, age: <span class="number">42</span> }

coffee&gt; view = <span class="keyword">new</span> UserView {user}
{ user: { name: <span class="string">'Foo'</span>, age: <span class="number">42</span> } }

coffee&gt; view.render()
<span class="string">'&lt;div&gt;Foo :)&lt;/div&gt;'</span></code></pre>
]]></description>
            <link>http://goodeggs.github.io/bites/post/41935904836/restructuring-assignment-in-coffeescript</link>
            <guid isPermaLink="true">
                http://goodeggs.github.io/bites/post/41935904836/restructuring-assignment-in-coffeescript            </guid>
            <dc:creator><![CDATA[Adam Hull]]></dc:creator>
            <pubDate>Tue, 12 Feb 2013 00:00:00 GMT</pubDate>
        </item>
        <item>
            <title><![CDATA[Teacup: CoffeeScript Templates for Developer Happiness]]></title>
            <description><![CDATA[<p><a href="http://goodeggs.github.com/teacup/"><img src="https://raw.github.com/goodeggs/teacup/master/docs/teacup.jpg" alt="Teacup"></a></p>
<p>We&#8217;ve released a <a href="http://goodeggs.github.com/teacup/">templating language</a> that feels just right for a team of full stack CoffeeScript developers optimizing for developer happiness.  Check out the <a href="http://goodeggs.github.com/teacup/#getting-started">example integrations</a> with Backbone, Express, and Rails, or try it neat in the browser.  Teacup builds on <a href="https://github.com/mark-hahn/drykup">a</a> <a href="https://github.com/markaby/markaby">rich</a> <a href="https://github.com/mauricemach/coffeekup">history</a> of templating in the language of your app to minimize context switching and toolchain duplication while trusting the developer to maintain separation between domain and templating tiers.  Here&#8217;s a quick sample:</p>
<pre class="highlighted"><code class="coffeescript">{renderable, ul, li, input} = require <span class="string">'teacup'</span>

template = renderable (teas)-&gt;
  ul -&gt;
    <span class="keyword">for</span> tea <span class="keyword">in</span> teas
      li tea
    input type: <span class="string">'button'</span>, value: <span class="string">'Steep'</span>

console.log template([<span class="string">'Jasmine'</span>, <span class="string">'Darjeeling'</span>])</code></pre>
<p>Outputs:</p>
<pre class="highlighted"><code class="xml"><span class="tag">&lt;<span class="title">ul</span>&gt;</span>
  <span class="tag">&lt;<span class="title">li</span>&gt;</span>Jasmine<span class="tag">&lt;/<span class="title">li</span>&gt;</span>
  <span class="tag">&lt;<span class="title">li</span>&gt;</span>Darjeeling<span class="tag">&lt;/<span class="title">li</span>&gt;</span>
<span class="tag">&lt;/<span class="title">ul</span>&gt;</span>
<span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"button"</span> <span class="attribute">value</span>=<span class="value">"Steep"</span>/&gt;</span></code></pre>
<p>Try it out!</p>
]]></description>
            <link>http://goodeggs.github.io/bites/post/40042760798/teacup-coffeescript-templates-for-developer-happiness</link>
            <guid isPermaLink="true">
                http://goodeggs.github.io/bites/post/40042760798/teacup-coffeescript-templates-for-developer-happiness            </guid>
            <dc:creator><![CDATA[Adam Hull]]></dc:creator>
            <pubDate>Tue, 08 Jan 2013 00:00:00 GMT</pubDate>
        </item>
        <item>
            <title><![CDATA[Synchronize AJAX calls for Backbone Models and Collections]]></title>
            <description><![CDATA[<p><strong>Problem</strong>: Backbone calls save, fetch and destroy concurrently on model and collection instances but we need to control the order in which they are called.</p>
<p><strong>Solution</strong>: Implement a custom sync method that chains AJAX calls using jQuery Deferred.<!-- more --></p>


<pre class="highlighted"><code class="javascript">withSerializedSync = <span class="keyword">function</span>(cls) {
  <span class="keyword">var</span> sync = cls.prototype.sync || Backbone.sync;
  cls.prototype.sync = <span class="keyword">function</span>() {
    <span class="keyword">var</span> args = arguments.length ? Array.prototype.slice.call(arguments,<span class="number">0</span>) : [];
    <span class="keyword">if</span> (!<span class="keyword">this</span>._lastSync) {
      <span class="keyword">this</span>._lastSync = sync.apply(<span class="keyword">this</span>, args);
    } <span class="keyword">else</span> {
      <span class="keyword">var</span> _<span class="keyword">this</span> = <span class="keyword">this</span>;
      <span class="keyword">this</span>._lastSync = <span class="keyword">this</span>._lastSync.then(<span class="keyword">function</span>() {
        <span class="keyword">return</span> sync.apply(_<span class="keyword">this</span>, args);
      });
    }
    <span class="keyword">return</span> <span class="keyword">this</span>._lastSync;
  };
}</code></pre>
<p><strong>The Back Story</strong></p>
<p>We recently ran into a scenario where we have a Backbone model, Basket, that may be modified on the server whenever it is saved. The modifications are things like removing items that are no longer for sale or updating pricing for items currently in the basket.</p>
<p>We save the basket regularly but only need to show it&#8217;s entire contents when the user views their basket or starts to check out. In these scenarios we re-fetch the basket to be sure that we have the most accurate and up to date information to show.</p>
<p>We uncovered a bug with this strategy in our integration tests. It&#8217;s possible to save the basket and then immediately re-fetch it&#8217;s content before the save is complete. In this case, you&#8217;ll actually get the old basket state from the fetch. This is extremely rare when a user is interacting with the site because people don&#8217;t usually click that fast, but our <a href="http://phantomjs.org/">PhantomJS</a> integration tests do - so we were seeing intermittent test failures due to unexpected basket contents coming back from the fetch.</p>
<p>We really want the fetch to wait until the save is complete - for AJAX calls from the basket to be synchronous, not the asynchronous default.</p>
<p>You can tell jQuery to make all of it&#8217;s ajax calls synchronously with <code><a href="http://api.jquery.com/jQuery.ajax/">{async: false}</a></code> but not Backbone on a per-model basis.</p>
<p>All Backbone ajax calls (create, save, fetch, remove) use the sync method under to hood. You can <a href="http://backbonejs.org/#Model-sync">implement your own sync method</a> to customize how those calls are made.</p>
<p><strong>Solution Details</strong></p>
<p>To accomplish to synchronize our ajax calls, we wrote a mixin (the gist above) for any Backbone model or collection that will run all ajax calls on a model instance serially instead of concurrently.</p>
<p>This mixin demonstrates a pattern we use commonly at Good Eggs. The mixin is a function that takes a reference to a class. It can define new prototype methods, monkey patch existing methods, define new object properties and add methods to the class.</p>
<p>In this case, our mixin defines a new sync method on the prototype or monkey patches it if it already exists. It uses the jQuery Deferred object returned by all ajax calls to chain calls to sync with <code>then</code>.</p>
<p>You can use this mixin to add this synchronous behavior to any Backbone model or collection.</p>

<pre class="highlighted"><code class="javascript"><span class="keyword">var</span> MyModel = Backbone.Model.extend({});
withSerializedSync(MyModel);</code></pre>
]]></description>
            <link>http://goodeggs.github.io/bites/post/38240004568/synchronize-ajax-calls-for-backbone-models-and</link>
            <guid isPermaLink="true">
                http://goodeggs.github.io/bites/post/38240004568/synchronize-ajax-calls-for-backbone-models-and            </guid>
            <dc:creator><![CDATA[Alon Salant]]></dc:creator>
            <pubDate>Tue, 18 Dec 2012 00:00:00 GMT</pubDate>
        </item>
        <item>
            <title><![CDATA[Synchronous node console with fibrous]]></title>
            <description><![CDATA[<p>Node’s interactive console, or <a href="http://nodejs.org/api/repl.html">REPL</a> (Read-Eval-Print-Loop), is handy for debugging and interacting directly with our applications. The one bummer is that it’s awkward to make asynchronous calls in the console especially when they need to be nested and writing them requires multiple lines for any hope of readability.</p>
<p><a href="https://github.com/goodeggs/fibrous">fibrous</a> simplifies async coding with Node and can help us out with the REPL too.
<!-- more --></p>
<pre class="highlighted"><code class="javascript"><span class="comment">// fibrous_repl.js</span>
<span class="keyword">var</span> vm = require(<span class="string">'vm'</span>);
<span class="keyword">var</span> repl = require(<span class="string">'repl'</span>);
<span class="keyword">var</span> fibrous = require(<span class="string">'fibrous'</span>);

console.log(<span class="string">"Starting fibrous REPL..."</span>);
repl.start({
  eval: fibrous(<span class="keyword">function</span>(code, context, file) {
    <span class="keyword">return</span> vm.runInContext(code, context, file);
  })
});</code></pre>
<p>Running this file with <code>node fibrous_repl.js</code> starts an interactive console with every command running in a fiber so that we can use <code>sync</code> and <code>wait</code> as we please.</p>
<pre class="highlighted"><code class="r">$ node fibrous_repl.js
Starting fibrous REPL...
&gt; var fs = <span class="keyword">require</span>(<span class="string">'fs'</span>);
undefined
&gt; data = fs.sync.readFile(<span class="string">'/etc/passwd'</span>, <span class="string">'utf-8'</span>);
<span class="keyword">...</span>
&gt; console.log(data);
<span class="comment">##</span>
<span class="comment"># User Database</span>
<span class="comment">#</span>
<span class="keyword">...</span></code></pre>
<p>We use the console a lot to poke at our apps, inspect live state and change data on the fly. Using fibrous as shown above makes it super easy.</p>
]]></description>
            <link>http://goodeggs.github.io/bites/post/36053394113/synchronous-node-console-with-fibrous</link>
            <guid isPermaLink="true">
                http://goodeggs.github.io/bites/post/36053394113/synchronous-node-console-with-fibrous            </guid>
            <dc:creator><![CDATA[Alon Salant]]></dc:creator>
            <pubDate>Sun, 18 Nov 2012 00:00:00 GMT</pubDate>
        </item>
        <item>
            <title><![CDATA[Reconnecting to MongoDB when Mongoose connect fails at startup]]></title>
            <description><![CDATA[<p>We recently experienced a short outage when a deploy to Heroku came up during a brief period when network connectivity to <a href="https://www.mongohq.com">MongoHQ</a> was down.</p>
<p>Our app came up but failed to connect to mongo. To our surprise, it did not attempt to reconnect, so even though MongoHQ came back quickly, our app continued to report errors<!-- more --> due to no mongo connection.</p>
<p>This was especially surprising since we use <a href="http://mongoosejs.com/">mongoose.js</a> to map to mongo, and mongoose passes the <em>auto_reconnect=true</em> flag to <a href="https://github.com/mongodb/node-mongodb-native">node-mongodb-native</a>. It turns out auto_reconnect (aka autoReconnect in some contexts) only comes in to play if the driver has already successfully established a connection to mongo.</p>
<p><a href="https://github.com/mongodb/node-mongodb-native/issues/655">According to the driver maintainers</a>, this is by design.</p>
<blockquote>
<p><span>by design, autoReconnect is after a successful connection. If you need to handle the case where your app is started before the server I recommend using setTimeout and doing your own connection logic for the db.open function.</span></p>
</blockquote>
<p><span>Seems like a bit of a cop out to me. You&#8217;ll try to reconnect on an interval if you loose the connection but not if you can&#8217;t connect initially? Doesn&#8217;t everyone need this functionality?</span></p>
<p>Well, we clearly do so we implemented it and are sharing it here for you.</p>

<pre class="highlighted"><code class="javascript"><span class="keyword">var</span> mongoose = require(<span class="string">'mongoose'</span>)
<span class="keyword">var</span> mongoUrl = <span class="string">"mongodb://localhost:27017/test"</span>

<span class="keyword">var</span> connectWithRetry = <span class="keyword">function</span>() {
  <span class="keyword">return</span> mongoose.connect(mongoUrl, <span class="keyword">function</span>(err) {
    <span class="keyword">if</span> (err) {
      console.error(<span class="string">'Failed to connect to mongo on startup - retrying in 5 sec'</span>, err);
      setTimeout(connectWithRetry, <span class="number">5000</span>);
    }
  });
};
connectWithRetry();</code></pre>
<p class="gist"><a href="http://gist.github.com/4092454">View gist on GitHub</a></p>]]></description>
            <link>http://goodeggs.github.io/bites/post/35878004826/reconnecting-to-mongodb-when-mongoose-connect-fails-at</link>
            <guid isPermaLink="true">
                http://goodeggs.github.io/bites/post/35878004826/reconnecting-to-mongodb-when-mongoose-connect-fails-at            </guid>
            <dc:creator><![CDATA[Alon Salant]]></dc:creator>
            <pubDate>Fri, 16 Nov 2012 00:00:00 GMT</pubDate>
        </item>
    </channel>
</rss>