<!DOCTYPE html><html class="no-js" lang="en"><head><meta charset="utf-8" /><title>Sticky A/B Tests with Fastly | Bites from Good Eggs</title><meta name="author" content="Bob Zoller" /><meta name="viewport" content="width=device-width, initial-scale=1" /><link rel="shortcut icon" href="/favicon.ico?v=2" /><link rel="stylesheet" href="/styles/main.css" /><link rel="alternate" title="RSS" type="application/rss+xml" href="/rss" /><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-26193287-5', 'github.io');
ga('send', 'pageview');</script></head><body><header><h1><a href="/">Bites</a></h1><ul class="unstyled nav"><li><a href="/">Blog</a></li><li><a href="/open_source/">Open Source</a></li><li><a href="/news/">News</a></li></ul></header><div id="main"><div id="content"><div><article class="post" role="article"><header><img class="author" src="https://goodeggs2.imgix.net/user_profile_photo/MshqSZmKT7GhgZ978b1Z_bob_zoller.jpg?w=150&amp;h=150&amp;q=&amp;fit=crop&amp;crop=faces" alt="Bob Zoller" /><h1 class="entry-title">Sticky A/B Tests with Fastly</h1><p class="meta"><a class="entry-author-name" href="/authors/bob_zoller/">Bob Zoller</a> on <time datetime="2016-06-06T19:00:00.000Z">June 6th, 2016</time></p></header><div class="entry-content"><p>Here at <a href="https://www.goodeggs.com/">Good Eggs</a>, we&#39;re in the process of moving all of our applications to a bespoke PaaS we call Ranch.  As soon as Ranch was ready for production traffic, we wanted to see how its performance differed from our current setup.  In this post I&#39;ll walk through how I set up a sticky A/B test using only <a href="https://www.fastly.com/">Fastly</a> and their custom VCL feature.</p>
<!-- more -->
<p>We had some very promising results from some early Apache Bench runs, but how might we determine the real-world performance difference between the two platforms?  Futhermore, how might we determine if there is a difference in user conversion?  For those that haven&#39;t heard, <a href="https://blog.kissmetrics.com/loading-time/">Loading Time Affects Your Bottom Line</a>.</p>
<p>We decided the answer to both would be to set up an A/B test with our website visitors.  We&#39;d route half of our customers to our current platform and half to Ranch, and then analyze the results.  To measure conversion over time, we&#39;d make the choice once per browser rather than once per request, aka &quot;sticky.&quot;  (Once per customer would be ideal, but not worth the extra effort.)</p>
<p>Luckily, we already used Fastly for SSL termination and edge caching.  What some folks don&#39;t know is that you can also upload custom Varnish Config Language (VCL) files to Fastly.  Starting with <a href="https://www.fastly.com/blog/best-practices-for-using-the-vary-header">an example from Fastly&#39;s docs</a>, I came up with this VCL:</p>
<pre><code><span class="hljs-sub"><span class="hljs-keyword">sub</span> vcl_recv {</span>
<span class="hljs-comment">#FASTLY recv</span>

  <span class="hljs-keyword">if</span> (req.http.Cookie ~ <span class="hljs-string">"platform="</span>) {
    <span class="hljs-regexp">//</span> TBD
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-regexp">//</span> <span class="hljs-number">50</span>% to Ranch
    <span class="hljs-keyword">if</span> (randombool(<span class="hljs-number">50</span>, <span class="hljs-number">100</span>)) {
      set req.http.GE-Set-Platform = <span class="hljs-string">"ranch"</span>;
    } <span class="hljs-keyword">else</span> {
      set req.http.GE-Set-Platform = <span class="hljs-string">"heroku"</span>;
    }
  }

}

<span class="hljs-sub"><span class="hljs-keyword">sub</span> vcl_deliver {</span>
<span class="hljs-comment">#FASTLY deliver</span>

  <span class="hljs-keyword">if</span> (req.http.GE-Set-Platform) {
    add resp.http.Set-Cookie = <span class="hljs-string">"platform="</span> req.http.GE-Set-Platform <span class="hljs-string">"; Domain=goodeggs.com; Path=/; Expires="</span> now + <span class="hljs-number">365</span>d <span class="hljs-string">";"</span>;
  }

}

[...snip...]</code></pre>

<p>This picks a platform once per browser (per 365 days), and store the choice in a cookie called <code>platform</code>.  Unlike Fastly&#39;s example, we won&#39;t set the cookie on every response.  (I should also note I&#39;m not concerned with any <code>Vary</code> header manipulation because my platforms serve the same content.  Be careful -- YMMV.)</p>
<p>But so far, nothing happens.  Let&#39;s fix that and switch backends based on our choice:</p>
<pre><code>[...snip...]

backend F_heroku { <span class="hljs-keyword">...</span> }
backend F_ranch { <span class="hljs-keyword">...</span> }

sub vcl_recv {
<span class="hljs-comment">#FASTLY recv</span>

  <span class="hljs-keyword">if</span> (req.http.Cookie ~ <span class="hljs-string">"platform=ranch"</span>) {
    set req.backend = F_ranch;
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (req.http.Cookie ~ <span class="hljs-string">"platform=heroku"</span>) {
    set req.backend = F_heroku;
  } <span class="hljs-keyword">else</span> {
    // <span class="hljs-number">50</span>% to Ranch
    <span class="hljs-keyword">if</span> (randombool(<span class="hljs-number">50</span>, <span class="hljs-number">100</span>)) {
      set req.http.GE-Set-Platform = <span class="hljs-string">"ranch"</span>;
      set req.backend = F_ranch;
    } <span class="hljs-keyword">else</span> {
      set req.http.GE-Set-Platform = <span class="hljs-string">"heroku"</span>;
      set req.backend = F_heroku;
    }
  }

}

[...snip...]</code></pre>

<p>And with that, we&#39;re routing traffic to both platforms.</p>
<p>Of course there&#39;s the problem of reporting and analyzing the data, but I&#39;ll leave that as an excercise to the reader.  In our case, our application log lines include response time, and we were able to tease apart the log lines and do the analysis in Sumo Logic.</p>
<p>There are lots of ways to do a split backend test like this, but if you&#39;ve got Fastly in front and are looking for cheap and easy, I&#39;m not sure you can beat this solution.</p>
<p>Want to help us build a bespoke PaaS and put more of the $50B US grocery spend into sustainable local food systems?  Get in touch!  <a href="http://careers.goodeggs.com/open-positions/">We&#39;re hiring</a>.</p>
</div><footer><p class="meta"><a class="basic-alignment left" href="/posts/girl-geek-dinner/">&laquo; Join Us for a Girl Geek Dinner Feb 17, 2016</a></p><div id="disqus_thread"></div><script>window.disqus_shortname = 'goodeggsbytes'; window.disqus_url = 'http://bites.goodeggs.com/post/sticky-ab-tests-with-fastly'</script><script async="async" src="//goodeggsbytes.disqus.com/embed.js"></script></footer></article></div></div></div><footer><div class="mission">Our mission is to grow and sustain local food systems worldwide.</div><p>Â©2013 Good Eggs, Inc</p></footer></body></html>