<!DOCTYPE html><html class="no-js" lang="en"><head><meta charset="utf-8" /><title>Synchronize AJAX calls for Backbone Models and Collections | Bites from Good Eggs</title><meta name="author" content="Alon Salant" /><meta name="viewport" content="width=device-width, initial-scale=1" /><link rel="shortcut icon" href="/favicon.ico?v=2" /><link rel="stylesheet" href="/styles/main.css" /><link rel="alternate" title="RSS" type="application/rss+xml" href="/rss" /><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-26193287-5', 'github.io');
ga('send', 'pageview');</script></head><body><header><h1><a href="/">Bites</a></h1><ul class="unstyled nav"><li><a href="/">Blog</a></li><li><a href="/open_source/">Open Source</a></li><li><a href="/news/">News</a></li></ul></header><div id="main"><div id="content"><div><article class="post" role="article"><header><img class="author" src="http://fpio.goodeggs.com/api/file/dr8oggORaYMYXX016dAQ/convert?w=150&amp;h=150&amp;fit=crop&amp;align=faces&amp;cache=true" alt="Alon Salant" /><h1 class="entry-title">Synchronize AJAX calls for Backbone Models and Collections</h1><p class="meta"><a class="entry-author-name" href="/authors/alon_salant/">Alon Salant</a> on <time datetime="2012-12-18T20:00:00.000Z">December 18th, 2012</time></p></header><div class="entry-content"><p><strong>Problem</strong>: Backbone calls save, fetch and destroy concurrently on model and collection instances but we need to control the order in which they are called.</p>
<p><strong>Solution</strong>: Implement a custom sync method that chains AJAX calls using jQuery Deferred.<!-- more --></p>


<pre><code class="js">withSerializedSync = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cls)</span> </span>{
  <span class="hljs-keyword">var</span> sync = cls.prototype.sync || Backbone.sync;
  cls.prototype.sync = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">arguments</span>.length ? <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>,<span class="hljs-number">0</span>) : [];
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._lastSync) {
      <span class="hljs-keyword">this</span>._lastSync = sync.apply(<span class="hljs-keyword">this</span>, args);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">var</span> _this = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">this</span>._lastSync = <span class="hljs-keyword">this</span>._lastSync.then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> sync.apply(_this, args);
      });
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._lastSync;
  };
}</code></pre>

<p><strong>The Back Story</strong></p>
<p>We recently ran into a scenario where we have a Backbone model, Basket, that may be modified on the server whenever it is saved. The modifications are things like removing items that are no longer for sale or updating pricing for items currently in the basket.</p>
<p>We save the basket regularly but only need to show it&#8217;s entire contents when the user views their basket or starts to check out. In these scenarios we re-fetch the basket to be sure that we have the most accurate and up to date information to show.</p>
<p>We uncovered a bug with this strategy in our integration tests. It&#8217;s possible to save the basket and then immediately re-fetch it&#8217;s content before the save is complete. In this case, you&#8217;ll actually get the old basket state from the fetch. This is extremely rare when a user is interacting with the site because people don&#8217;t usually click that fast, but our <a href="http://phantomjs.org/">PhantomJS</a> integration tests do - so we were seeing intermittent test failures due to unexpected basket contents coming back from the fetch.</p>
<p>We really want the fetch to wait until the save is complete - for AJAX calls from the basket to be synchronous, not the asynchronous default.</p>
<p>You can tell jQuery to make all of it&#8217;s ajax calls synchronously with <code><a href="http://api.jquery.com/jQuery.ajax/">{async: false}</a></code> but not Backbone on a per-model basis.</p>
<p>All Backbone ajax calls (create, save, fetch, remove) use the sync method under to hood. You can <a href="http://backbonejs.org/#Model-sync">implement your own sync method</a> to customize how those calls are made.</p>
<p><strong>Solution Details</strong></p>
<p>To accomplish to synchronize our ajax calls, we wrote a mixin (the gist above) for any Backbone model or collection that will run all ajax calls on a model instance serially instead of concurrently.</p>
<p>This mixin demonstrates a pattern we use commonly at Good Eggs. The mixin is a function that takes a reference to a class. It can define new prototype methods, monkey patch existing methods, define new object properties and add methods to the class.</p>
<p>In this case, our mixin defines a new sync method on the prototype or monkey patches it if it already exists. It uses the jQuery Deferred object returned by all ajax calls to chain calls to sync with <code>then</code>.</p>
<p>You can use this mixin to add this synchronous behavior to any Backbone model or collection.</p>

<pre><code class="js"><span class="hljs-keyword">var</span> MyModel = Backbone.Model.extend({});
withSerializedSync(MyModel);</code></pre></div><footer><p class="meta"><a class="basic-alignment left" href="/posts/synchronous-node-console-with-fibrous/">&laquo; Synchronous node console with fibrous</a><a class="basic-alignment right" href="/posts/teacup-coffeescript-templates-for-developer-happiness/">Teacup: CoffeeScript Templates for Developer Happiness &raquo;</a></p><div id="disqus_thread"></div><script>window.disqus_shortname = 'goodeggsbytes'; window.disqus_url = 'http://bytes.goodeggs.com/post/38240004568/synchronize-ajax-calls-for-backbone-models-and'</script><script async="async" src="//goodeggsbytes.disqus.com/embed.js"></script></footer></article></div></div></div><footer><div class="mission">Our mission is to grow and sustain local food systems worldwide.</div><p>Â©2013 Good Eggs, Inc</p></footer></body></html>