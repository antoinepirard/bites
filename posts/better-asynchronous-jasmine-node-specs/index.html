<!DOCTYPE html><html class="no-js" lang="en"><head><meta charset="utf-8" /><title>Better asynchronous jasmine-node specs | Bites from Good Eggs</title><meta name="author" content="Alon Salant" /><meta name="viewport" content="width=device-width, initial-scale=1" /><link rel="shortcut icon" href="/favicon.ico?v=2" /><link rel="stylesheet" href="/styles/main.css" /><link rel="alternate" title="RSS" type="application/rss+xml" href="/rss" /><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-26193287-5', 'github.io');
ga('send', 'pageview');</script></head><body><header><h1><a href="/">Bites</a></h1><ul class="unstyled nav"><li><a href="/">Blog</a></li><li><a href="/open_source/">Open Source</a></li><li><a href="/news/">News</a></li></ul></header><div id="main"><div id="content"><div><article class="post" role="article"><header><img class="author" src="https://goodeggs2.imgix.net/user_profile_photo/XyyXQtPpS6yeWbBMCMXj_alon_salant.jpg?w=150&amp;h=150&amp;q=&amp;fit=crop&amp;crop=faces" alt="Alon Salant" /><h1 class="entry-title">Better asynchronous jasmine-node specs</h1><p class="meta"><a class="entry-author-name" href="/authors/alon_salant/">Alon Salant</a> on <time datetime="2011-11-25T20:00:00.000Z">November 25th, 2011</time></p></header><div class="entry-content"><p><b>Update 2/5/2012:</b> as of version 1.0.15 jasmine-node includes this enhancement to support asynchronous specs. The original post follows&#8230;</p>

<p>We&#8217;re using <a href="https://github.com/mhevery/jasmine-node">jasmine-node</a> for BDD-style testing of our node apps. It&#8217;s not an amazing implementation of jasmine for node but it gets the job done.</p>

<p>One of my issues with jasmine-node is its awkward support for asynchronous tests with the global <code>asyncSpecWait</code> and <code>asyncSpecDone</code> methods.</p>

<p>Inspired by the BDD style supported by <a href="http://visionmedia.github.com/mocha">Mocha</a>, I <!-- more -->decided that our jasmine specs should support asynchronous specs in the same style where <code>it</code>, <code>beforeEach</code> and <code>afterEach</code> wait until the spec is finished if passed a function that expects a <code>done</code> callback.</p>

<pre><code class="coffee">describe <span class="hljs-string">'User'</span>,<span class="hljs-function"> -&gt;</span>
  describe <span class="hljs-string">'#save()'</span>,<span class="hljs-function"> -&gt;</span>
    it <span class="hljs-string">'should save without error'</span>, <span class="hljs-function"><span class="hljs-params">(done)</span> -&gt;</span>
      user = <span class="hljs-keyword">new</span> User(<span class="hljs-string">'Luna'</span>)
      user.save <span class="hljs-function"><span class="hljs-params">(error)</span> -&gt;</span>
        expect(error).toBeNull()
        done();</code></pre>

<p>The <code>done</code> callback will fail the spec if passed an error, so even more succinctly:</p>

<pre><code class="coffee">describe <span class="hljs-string">'User'</span>,<span class="hljs-function"> -&gt;</span>
  describe <span class="hljs-string">'#save()'</span>,<span class="hljs-function"> -&gt;</span>
    it <span class="hljs-string">'should save without error'</span>, <span class="hljs-function"><span class="hljs-params">(done)</span> -&gt;</span>
      user = <span class="hljs-keyword">new</span> User(<span class="hljs-string">'Luna'</span>)
      user.save(done)</code></pre>

<p>In order to modify the behavior of the jasmine spec methods, I wrote a spec helper that monkey patches <code>it</code>, <code>beforeEach</code> and <code>afterEach</code> to run with asynchronous support if the spec is written to expect a <code>done</code> handler. <a href="http://gist.github.com/1394976">Here&#8217;s a Gist</a> of my file <code>async_helper.coffee</code> that I have in my <code>spec/support</code> folder.</p>

<pre><code class="coffee"><span class="hljs-comment"># Monkey patch jasmine.Env to wrap spec ('it', 'beforeEach', 'afterEach')</span>
<span class="hljs-comment"># in async handler if it expects a done callback</span>
withoutAsync = {}
<span class="hljs-keyword">for</span> jasmineFunction <span class="hljs-keyword">in</span> [ <span class="hljs-string">"it"</span>, <span class="hljs-string">"beforeEach"</span>, <span class="hljs-string">"afterEach"</span>]
  <span class="hljs-keyword">do</span> <span class="hljs-function"><span class="hljs-params">(jasmineFunction)</span> -&gt;</span>
    withoutAsync[jasmineFunction] = jasmine.Env.prototype[jasmineFunction]
    jasmine.Env.prototype[jasmineFunction] = <span class="hljs-function"><span class="hljs-params">(args...)</span> -&gt;</span>
      specFunction = args.pop()
      <span class="hljs-comment"># No async callback expected, so not async</span>
      <span class="hljs-keyword">if</span> specFunction.length == <span class="hljs-number">0</span>
        args.push specFunction
      <span class="hljs-keyword">else</span>
        args.push<span class="hljs-function"> -&gt;</span> asyncSpec(specFunction, @)

      withoutAsync[jasmineFunction].apply @, args

<span class="hljs-comment"># Run any function, failing the current spec if there is an error or it times out</span>
<span class="hljs-function"><span class="hljs-title">asyncSpec</span> = <span class="hljs-params">(specFunction, spec, timeout = <span class="hljs-number">1000</span>)</span> -&gt;</span>
  done = <span class="hljs-literal">false</span>
  spec.runs<span class="hljs-function"> -&gt;</span>
    <span class="hljs-keyword">try</span>
      specFunction <span class="hljs-function"><span class="hljs-params">(error)</span> -&gt;</span>
        done = <span class="hljs-literal">true</span>
        spec.fail(error) <span class="hljs-keyword">if</span> error?
    <span class="hljs-keyword">catch</span> e
      <span class="hljs-comment"># if we hit an exception before any async code, mark the spec done</span>
      done = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">throw</span> e
  spec.waitsFor<span class="hljs-function"> -&gt;</span>
    done == <span class="hljs-literal">true</span>
  , <span class="hljs-string">"spec to complete"</span>, timeout</code></pre>

<p>The use of <code>Function.length</code> to check how many arguments a function expects was a new and very handy trick that made this spec style possible. Much better!!</p>

</div><footer><p class="meta"><a class="basic-alignment left" href="/posts/debugging-jasmine-node-and-coffeescript-specs/">&laquo; Debugging jasmine-node and CoffeeScript specs</a><a class="basic-alignment right" href="/posts/t4three-at-good-eggs-hq/">Tea for Three at Good Eggs HQ &raquo;</a></p><div id="disqus_thread"></div><script>window.disqus_shortname = 'goodeggsbytes'; window.disqus_url = 'http://bytes.goodeggs.com/post/13332056735/better-asynchronous-jasmine-node-specs'</script><script async="async" src="//goodeggsbytes.disqus.com/embed.js"></script></footer></article></div></div></div><footer><div class="mission">Our mission is to grow and sustain local food systems worldwide.</div><p>Â©2013 Good Eggs, Inc</p></footer></body></html>