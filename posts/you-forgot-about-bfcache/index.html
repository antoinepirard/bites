<!DOCTYPE html><html class="no-js" lang="en"><head><meta charset="utf-8" /><title>You Forgot About bfcache! | Bites from Good Eggs</title><meta name="author" content="Brian Underwood" /><meta name="viewport" content="width=device-width, initial-scale=1" /><link rel="shortcut icon" href="/favicon.ico?v=2" /><link rel="stylesheet" href="/styles/main.css" /><link rel="alternate" title="RSS" type="application/rss+xml" href="/rss" /><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-26193287-5', 'github.io');
ga('send', 'pageview');</script></head><body><header><h1><a href="/">Bites</a></h1><ul class="unstyled nav"><li><a href="/">Blog</a></li><li><a href="/open_source/">Open Source</a></li><li><a href="/news/">News</a></li></ul></header><div id="main"><div id="content"><div><article class="post" role="article"><header><img class="author" src="https://goodeggs.imgix.net/user_profile_photo/wqBhuzbETnSwRPCNXTxA_Brian.jpg?w=150&amp;h=150&amp;fit=crop&amp;crop=faces" alt="Brian Underwood" /><h1 class="entry-title">You Forgot About bfcache!</h1><p class="meta"><a class="entry-author-name" href="/authors/brian_underwood/">Brian Underwood</a> on <time datetime="2014-05-28T19:00:00.000Z">May 28th, 2014</time></p></header><div class="entry-content"><style>.entry-content img { display: block; margin: 0 auto }</style>

<p>So there we were, putting the polishing touches on our mobile app.  There were a few big bugs that we wanted to clean up before we launched.  One seemed a bit edge-case-y, but still not good: when iPhone users clicked on products and then subsequently clicked back to the product listings, they saw our animated spinner stuck like this:</p>
<p><img src="/images/spin-spin.gif" alt="Waiting for user to reload"></p>
<!-- more -->

<p>It seemed straightforward enough, but it required some researching until we ran across this <a href="https://stackoverflow.com/questions/8788802/prevent-safari-loading-from-cache-when-back-button-is-clicked">stack overflow post</a>.</p>
<p>bfcache, eh?</p>
<p><img src="/images/cosby-huh.gif" alt="bfcache?"></p>
<p>From the Stack Overflow answer:</p>
<blockquote>
<p>&quot;[bfcache] is supposed to save complete state of page when user navigates away.
When user navigates back with back button page can be loaded from cache very quickly.
This is different from normal cache which only caches HTML code.&quot;</p>
</blockquote>
<p>It turns out that all browsers support bfcache, but Mobile Safari sometimes needed a little extra help.  That led us to try something along the lines of this:</p>
<pre><code class="coffee"><span class="hljs-built_in">window</span>.onpageshow, <span class="hljs-function"><span class="hljs-params">(event)</span> =&gt;</span>
      <span class="hljs-keyword">if</span> event.persisted
        overlay.hide() <span class="hljs-comment"># Hide the spinner overlay</span></code></pre>

<p>Seemed like it should work, but it didn&#39;t!  After a lot more research and even more a lot more trial-and-error, we noticed we had multiple window.onpageshow assignments.  jQuery to the rescue (yet again)!</p>
<pre><code class="coffee">$<span class="hljs-function"><span class="hljs-params">(<span class="hljs-built_in">window</span>)</span>.<span class="hljs-title">on</span> '<span class="hljs-title">pageshow</span>', <span class="hljs-params">(event)</span> =&gt;</span>
      <span class="hljs-keyword">if</span> event.persisted
        overlay.hide()</code></pre>

<p>With our fix in place we were ready to head home and have a beer, right?  Nope!  What if we needed to sneak past bfcache again?  Well how about we move the code to our main Page class and define an overwritable function called onBrowserBack?</p>
<pre><code class="coffee">$<span class="hljs-function"><span class="hljs-params">(<span class="hljs-built_in">window</span>)</span>.<span class="hljs-title">on</span> '<span class="hljs-title">pageshow</span>', <span class="hljs-params">(event)</span> =&gt;</span>
      <span class="hljs-keyword">if</span> event.persisted
        overlay.hide()
        <span class="hljs-property">@onBrowserBack</span>?()</code></pre>

<p><img src="/images/BOOM.gif" alt="BOOM!"></p>
<p>This turned out to be really useful because the counter of items added to the basket in our navigation menu wasn&#39;t updating either.  We just threw a bit of code into the onBrowserBack function for our product listing page which made a request to get new session data and we&#39;d fixed two bugs with one event.</p>
<p>If you&#39;ve read this far and you&#39;re interested in more on the ins-and-outs of how browsers deal with caching history you&#39;ll probably find <a href="http://madhatted.com/2013/6/16/you-do-not-understand-browser-history">You do not understand browser history</a> interesting and useful!</p>
</div><footer><p class="meta"><a class="basic-alignment left" href="/posts/written-hiring-criteria/">&laquo; What Are Your Hiring Criteria?</a><a class="basic-alignment right" href="/posts/promises-trycatch-zones/">Comparing Node.js Promises, Try/Catch, Angular Zone.js and yes, Zone &raquo;</a></p><div id="disqus_thread"></div><script>window.disqus_shortname = 'goodeggsbytes'; window.disqus_url = 'http://bites.goodeggs.com/posts/you-forgot-about-bfcache/'</script><script async="async" src="//goodeggsbytes.disqus.com/embed.js"></script></footer></article></div></div></div><footer><div class="mission">Our mission is to grow and sustain local food systems worldwide.</div><p>Â©2013 Good Eggs, Inc</p></footer></body></html>