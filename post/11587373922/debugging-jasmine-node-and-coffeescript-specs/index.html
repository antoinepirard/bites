<!DOCTYPE html><html class="no-js" lang="en"><head><meta charset="utf-8" /><title>Debugging jasmine-node and CoffeeScript specs | Bites from Good Eggs</title><meta name="author" content="Alon Salant" /><meta name="viewport" content="width=device-width, initial-scale=1" /><link rel="icon" type="image/png" href="../../../favicon.png" /><link rel="stylesheet" href="../../../styles/main.css" /><link rel="alternate" title="RSS" type="application/rss+xml" href="../../../rss" /><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-26193287-5', 'github.io');
ga('send', 'pageview');</script></head><body><header><h1><a href="../../../">Bites</a></h1><ul class="unstyled nav"><li><a href="../../../">Blog</a></li><li><a href="../../../open_source">Open Source</a></li><li><a href="../../../news">News</a></li></ul></header><div id="main"><div id="content"><div><article class="hentry" role="article"><header><h1 class="entry-title">Debugging jasmine-node and CoffeeScript specs</h1><p class="meta"><a href="../../../authors/alon_salant/">Alon Salant</a> on <time datetime="2011-10-17T00:00:00.000Z">October 17th, 2011</time></p></header><div class="entry-content"><p>We’re writing our node apps in <a href="http://jashkenas.github.com/coffee-script/">CoffeeScript</a>, debugging with <a href="https://github.com/dannycoates/node-inspector">node-inspector</a> and testing with <a href="https://github.com/mhevery/jasmine-node">jasmine-node</a>.
</p></p>
<p>
jasmine-node does not provide a mechanism to pass command line options to node, so to run a spec with debugging enabled, you <!-- more -->run jasmine-node with:
</p>

<pre class="highlighted"><code class="bash">node --debug-brk node_modules/jasmine-node/lib/jasmine-node/cli.js \
  specs/app.spec.js</code></pre>
<p>
This will stop the debugger on the first line of cli.js. Open node-inspector in your browser per it’s instructions and you’ll see the debugger stopped there. Put a ‘debugger;’ line at the spot in your code where you want to stop and debug, continue execution and you’ll be at the ‘debugger;’ line. Good to go.
</p>
<p>
To do the same thing for a spec written in CoffeeScript, you would run jasmine-node with:
</p>

<pre class="highlighted"><code class="bash">node --debug-brk node_modules/jasmine-node/lib/jasmine-node/cli.js \
  --coffee specs/app.spec.coffee</code></pre>
<p>
We aren’t entirely happy with jasmine-node. For example it automatically requires all spec helpers and copies their exported methods and objects to GLOBAL. It’s support for asynchronous specs is fairly primitive.
</p>
<p>
We took a quick stab at writing a new runner for jasmine that would run our coffee node specs. The following uses only the TerminalReporter that comes with the jasmine-node npm module and the version of Jasmine that it bundles:
</p>

<pre class="highlighted"><code class="coffeescript">process.env.NODE_ENV = <span class="string">'test'</span> <span class="keyword">unless</span> process.env.NODE_ENV?

sys = require <span class="string">"sys"</span>
_ = require <span class="string">"underscore"</span>

dir = <span class="string">"jasmine-node/lib/jasmine-node/"</span>
filename =  <span class="string">"jasmine-2.0.0.rc1"</span>

<span class="comment"># Copy 'it', 'describe',... to global</span>
<span class="keyword">for</span> key, value <span class="keyword">of</span> require(<span class="string">"<span class="subst">#{dir}</span><span class="subst">#{filename}</span>"</span>)
  global[key] = value

<span class="comment"># Use jasmine-node's TerminalReporter for console output</span>
TerminalReporter = require(<span class="string">"<span class="subst">#{dir}</span>reporter"</span>).TerminalReporter
jasmine.getEnv().addReporter(<span class="keyword">new</span> TerminalReporter(
  print: sys.print
  color: <span class="literal">true</span>
  stackFilter: (text) -&gt;
    _(text.split <span class="regexp">/\n/</span>).filter((line) -&gt; line.indexOf(<span class="string">"<span class="subst">#{dir}</span><span class="subst">#{filename}</span>"</span>) == -<span class="number">1</span>).join(<span class="string">'\n'</span>)
))

process.nextTick -&gt;
  jasmine.getEnv().execute()</code></pre>
<p>
To use this runner, we require it in our spec_helper.coffee file and require spec_helper.coffee at the top of each of our specs. With this setup, running a spec is as simple as:
</p>

<pre class="highlighted"><code class="bash">coffee spec/app.spec.coffee</code></pre>
<p>
And debugging is as simple as:
</p>

<pre class="highlighted"><code class="bash">coffee --nodejs --debug-brk spec/app.spec.coffee</code></pre>
<p>
Sweet.
</p>
<p>
I like running my specs this way but like jasmine-node for running a whole suite of tests locally and in continuous integration. To have both working together, we only include this runner in our spec_helper.coffee if jasmine has not already been loaded by jasmine-node:
</p>

<pre class="highlighted"><code class="coffeescript">process.env.NODE_ENV = <span class="string">'test'</span> <span class="keyword">unless</span> process.env.NODE_ENV?

require <span class="string">'./jasmine_runner'</span> <span class="keyword">unless</span> jasmine?

<span class="comment">#...</span></code></pre>
<p>
With this setup, I can easily run my coffee specs from the command line and my entire suite before committing and in continuous integration.
</p></div><footer><p class="meta"><a class="basic-alignment right" href="../../../post/13332056735/better-asynchronous-jasmine-node-specs">Better asynchronous jasmine-node specs &raquo;</a></p><div id="disqus_thread"></div><script>window.disqus_shortname = 'goodeggsbytes'; window.disqus_url = 'http://bytes.goodeggs.com/post/11587373922/debugging-jasmine-node-and-coffeescript-specs'</script><script async="async" src="//goodeggsbytes.disqus.com/embed.js"></script></footer></article></div></div></div><footer><div class="mission">Our mission is to grow and sustain local food systems worldwide.</div><p>©2013 Good Eggs, Inc</p></footer><!--[if !(lte IE 8)]><!-->
<script>
  (function(){
    var e = document.createElement('script'); e.type='text/javascript'; e.async = true;
    e.src = document.location.protocol + '//d1ux67szpr7bp0.cloudfront.net/project-megaphone/widget.min.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(e, s);
  })();
</script>
<!--<![endif]--></body></html>